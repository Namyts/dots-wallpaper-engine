<html>

<head>
	<script src="https://pixijs.download/v8.1.2/pixi.min.js"></script>
	<script src="./pixi.min.js"></script>
	<script>
		window.dvd = `
		<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" x="0" y="0" viewBox="0 0 500 300" style="enable-background:new 0 0 500 300" xml:space="preserve"><style>.st0{fill-rule:evenodd;clip-rule:evenodd}</style><path class="st0" d="M469.9 212.1h-14.7l-.4 2.2h6.2l-2.2 17.3h2.6l2.3-17.3h5.7zM480.1 224.9l-3.1-12.8h-1.8l-6.7 19.5h2.2l5.4-15.1 3.1 15.1 8-15.1v15.1h2.6v-19.5h-2.6zM76.2 282.1 59 249.7H44.3l27.1 49.7h8.4l27.5-49.7H92.2zM141 275.4v24h13.3v-49.7H141zM285 299.4h36.8V291h-23v-13.3h21.7v-8.5h-21.7v-11h23v-8.5H285zM472 188.1c0-18.6-105.6-33.7-236-33.7S0 169.5 0 188.1s105.7 33.7 236 33.7 236-15 236-33.7zm-298.7.5c0-6.2 24.2-11.1 54.1-11.1s54 5 54 11-24.1 11.1-54 11.1-54-5-54-11zM392.3 249.5c-19.3 0-35 11.1-35 24.8s15.7 24.8 35 24.8 35-11 35-24.8c0-13.7-15.7-24.8-35-24.8zm0 40.6c-11.5 0-20.8-7-20.8-15.8 0-8.7 9.3-15.7 20.8-15.7s20.8 7 20.8 15.7-9.3 15.8-20.8 15.8zM214.8 249.7h-21v49.7h21s33.4 0 33.4-24.6-33.4-25-33.4-25zm-7 41.2v-32.7s26.2-1.7 26.2 16.5c0 18.1-26.1 16.2-26.1 16.2zM192 54.3a78 78 0 0 0-4-26.2h1.7L234.5 154 344.5 28h59.3S450 26.8 450 56.5s-38.4 41.2-63 41.2h-10.6l13.8-59.4h-48.3l-20.4 86.4h65.8c63 0 112.8-34.6 112.8-70.4C500 1.3 418.9.6 418.9.6h-102l-64.7 81.6L227 .6H43l-6.7 27.5h61.5c8.7.2 44 2.4 44 28.4 0 29.7-38.4 41.2-62.9 41.2H68.3L82 38.3H33.7l-20.4 86.4h65.8c63 0 112.8-34.6 112.8-70.4z"/></svg>
		`
	</script>
</head>

<body style="margin: 0px;">
	<div id="app"></div>
	<script>
		let config = {
			antialias: true,
			fps: 120,
			background: '#000000',
			shape: 'circle',
			minSpeed: 0.25,
			maxSpeed: 0.75,
			shapeScaleMin: 1,
			shapeScaleMax: 9,
			shapesPer100px: 4,
			maxTotalShapes: 20000,
			minR: 0,
			maxR: 255,
			minG: 0,
			maxG: 255,
			minB: 0,
			maxB: 255,
			colourChangeOnWallHit: false,
			audioSizeBoost: 4,
			audioSpeedBoost: 100,
			audioSpeedBoostWidth: 24,
			maxBoostScale: 5,
			maxBoostSpeed: 100,
			equalise: 0.4
		}

		let app = null
		const restartApplication = () => {
			if(app){
				app.destroy(true,true)
				app = null
				runApplication()
			} else {
				runApplication()
			}			
		}

		window.onresize = () => {app && app.resize()}
		window.wallpaperPropertyListener = {
			applyUserProperties: properties => {
				config = {...config,...Object.fromEntries(Object.entries(properties).map(([p,v])=>[p,v.value]))}
				restartApplication()
			},
			applyGeneralProperties: properties => {
				const {fps, msaa} = properties
				config = {...config, fps: fps.value, antialias: msaa && msaa!=="none"}
				restartApplication()
			}
		}

		const randomIntBetween = (a,b) => Math.ceil(randomBetween(a,b))
		const randomBetween = (a,b) => a + Math.random()*(b-a)

		const chooseRandomColour = shape => {
			const [r,g,b] = [
				randomIntBetween(config.minR,config.maxR),
				randomIntBetween(config.minG,config.maxG),
				randomIntBetween(config.minB,config.maxB)
			]
			shape.tint = `rgb(${r},${g},${b})`
		}

		const drawShapeAndGetSize = (shapeType, initialScale) => {
			const g = new PIXI.Graphics()
			switch(shapeType){
				case "dvd": { return [ g.svg(window.dvd), 500, 300 ] }
				case "square": {
					const s = 4*initialScale
					return [ g.rect(0,0,s,s), s, s ]
				}
				default: { 
					const r = 4*initialScale
					return [ g.circle(r, r, r), 2*r, 2*r ]
				}
			}
		}

		const runApplication = () => {
			let wallsHit = 0
			let cornersHit = 0
			const audioChannels = 128
			app = new PIXI.Application();
			app.init({ resizeTo: window, antialias: config.antialias, background: config.background })
			.then(()=>{
				document.getElementById("app").appendChild(app.canvas)
				const shapes = []
				const numberOfShapes = Math.min(config.maxTotalShapes, Math.floor(config.shapesPer100px*(app.renderer.width*app.renderer.height)/10000))

				for (let i = 0; i < numberOfShapes; i++) {
					const initialScale = randomBetween(config.shapeScaleMin,config.shapeScaleMax)
					const initialSpeed = randomBetween(config.minSpeed,config.maxSpeed)
					const initialAngle = randomBetween(0,2*Math.PI)
					const velocity = [Math.cos(initialAngle) * initialSpeed, Math.sin(initialAngle) * initialSpeed]
					
					let [shape, width, height] = drawShapeAndGetSize(config.shape, initialScale)

					shape.fill({color: "white", alpha: 0.75})
					chooseRandomColour(shape)
					shape.x = randomIntBetween(0,app.renderer.width - (width * initialScale))
					shape.y = randomIntBetween(0,app.renderer.height - (height * initialScale))

					shapes.push({ shape, velocity, initialScale, initialSpeed, width, height })
					app.stage.addChild(shape);
				}

				let audio = new Array(audioChannels).fill(0)

				app.ticker.maxFPS = config.fps

				app.ticker.add((ticker) => {
					const delta = ticker.deltaTime

					const audioSpeedBoost = Math.max(1,(audio.slice(1,config.audioSpeedBoostWidth).reduce((t,a)=>t+a,0)/config.audioSpeedBoostWidth)*config.audioSpeedBoost)
					shapes.forEach(({ shape, velocity, initialScale, initialSpeed, width, height }, index) => {
						//size changes
						const audioSizeBoost = Math.max(1,audio[index%audioChannels]*config.audioSizeBoost)
						const currentScale = shape.scale.x
						const targetScale = Math.min(config.maxBoostScale/initialScale, currentScale + (audioSizeBoost-currentScale)*config.equalise)

						let bounces = 0
						//position changes
						let [dx, dy] = velocity
						if (shape.x >= app.renderer.width - (width * targetScale) || shape.x <= 0) {
							bounces += 1
							dx = dx * -1
							shapes[index].velocity[0] = dx
						}
						if (shape.y >= app.renderer.height - (height * targetScale) || shape.y <= 0) {
							bounces += 1
							dy = dy * -1
							shapes[index].velocity[1] = dy
						}
						if(bounces > 0){
							wallsHit += bounces
							config.colourChangeOnWallHit && chooseRandomColour(shape)
							if(bounces === 2){
								cornersHit += 1
								console.log(cornersHit)
							}
						}


						const currentDx = dx * delta
						const currentDy = dy * delta
						const targetDx = currentDx * audioSpeedBoost
						const targetDy = currentDy * audioSpeedBoost

						const x = shape.x + Math.sign(targetDx)*Math.min(config.maxBoostSpeed,Math.abs(targetDx))
						const y = shape.y + Math.sign(targetDy)*Math.min(config.maxBoostSpeed,Math.abs(targetDy))

						//set values with a final check to keep the shape within bounds
						shape.x = Math.min(Math.max(x,0),app.renderer.width - (width * targetScale))
						shape.y = Math.min(Math.max(y,0),app.renderer.height - (height * targetScale))
						shape.scale.set(targetScale)
					})
				})
				const wallpaperAudioListener = a => {audio = a.map(v=>Math.min(v,1))}
				window.wallpaperRegisterAudioListener && window.wallpaperRegisterAudioListener(wallpaperAudioListener)
			})
		}

		runApplication()
	</script>
</body>

</html>