<html>

<head>
	<script src="https://pixijs.download/release/pixi.min.js"></script>
</head>

<body style="margin: 0px;">
	<script>
		const randomBetween = (a,b) => a + Math.random()*(b-a)

		const audioChannels = 128
		const width = window.innerWidth
		const height = window.innerHeight
		const app = new PIXI.Application({ width, height, antialias: true });
		document.body.appendChild(app.view);

		let minSpeed = 0.25
		let maxSpeed = 0.75
		let circleMin = 5
		let circleMax = 35
		let circleCount = 500
		const circles = []

		let minR = 0
		let maxR = 255
		let minG = 0
		let maxG = 255
		let minB = 0
		let maxB = 255

		window.wallpaperPropertyListener = {
			applyUserProperties: (properties) => {
				if (!isNaN(properties.minSpeed)) {minSpeed = properties.minSpeed}
			},
		}

		const screen = new PIXI.Graphics()
		app.stage.addChild(screen)

		for (let i = 0; i < circleCount; i++) {
			const circle = new PIXI.Graphics()
			circle.beginFill('rgba(255,255,255,0.75)')
			const initialR = randomBetween(circleMin,circleMax)
			circle.drawCircle(0, 0, initialR)
			const speed = randomBetween(minSpeed,maxSpeed)
			const initialAngle = Math.random() * 2 * Math.PI
			const velocity = [Math.cos(initialAngle) * speed, Math.sin(initialAngle) * speed]
			circles.push({ circle, velocity })
			screen.addChild(circle);
		}

		circles.forEach(({ circle }) => {
			circle.x = Math.random() * width
			circle.y = Math.random() * height
			const [r, g, b] = [randomBetween(minR,maxR), randomBetween(minG,maxG), randomBetween(minB,maxB)]
			circle.tint = `rgb(${r},${g},${b})`
		})

		let audio = new Array(audioChannels).fill(0)

		let elapsed = 0.0;
		app.ticker.add((delta) => {
			elapsed += delta;

			circles.forEach(({ circle, velocity }, index) => {

				const audioBoost = 1 + audio[index%audioChannels]

				let [dx, dy] = velocity
				if (circle.x > width || circle.x < 0) {
					dx = dx * -1
					circles[index].velocity[0] = dx
				}
				if (circle.y > height || circle.y < 0) {
					dy = dy * -1
					circles[index].velocity[1] = dy
				}
				circle.x = circle.x + dx * delta * audioBoost
				circle.y = circle.y + dy * delta * audioBoost
			})
		});
		const wallpaperAudioListener = a => {audio = a.map(v=>Math.max(v,1))}
		window.wallpaperRegisterAudioListener && window.wallpaperRegisterAudioListener(wallpaperAudioListener)
	</script>
</body>

</html>