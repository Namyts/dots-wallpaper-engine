<html>

<head>
	<script src="https://pixijs.download/release/pixi.min.js"></script>
</head>

<body style="margin: 0px;">
	<script>
		let config = {
			fps: 30,
			minSpeed: 0.25,
			maxSpeed: 0.75,
			circleMin: 5,
			circleMax: 35,
			circleCount: 500,
			minR: 0,
			maxR: 255,
			minG: 0,
			maxG: 255,
			minB: 250,
			maxB: 255
		}

		window.wallpaperPropertyListener = {
			applyUserProperties: properties => {
				config = {...config,...properties}
			},
			applyGeneralProperties: properties => {
				config = {...config,...properties}
			}
		}

		const randomBetween = (a,b) => a + Math.random()*(b-a)

		const audioChannels = 128
		const width = window.innerWidth
		const height = window.innerHeight
		const app = new PIXI.Application({ width, height, antialias: true });
		document.body.appendChild(app.view);

		const screen = new PIXI.Graphics()
		app.stage.addChild(screen)

		const circles = []

		for (let i = 0; i < config.circleCount; i++) {
			const circle = new PIXI.Graphics()
			circle.beginFill('rgba(255,255,255,0.75)')
			const initialR = randomBetween(config.circleMin,config.circleMax)
			circle.drawCircle(0, 0, initialR)
			const speed = randomBetween(config.minSpeed,config.maxSpeed)
			const initialAngle = Math.random() * 2 * Math.PI
			const velocity = [Math.cos(initialAngle) * speed, Math.sin(initialAngle) * speed]
			circles.push({ circle, velocity })
			screen.addChild(circle);
		}

		circles.forEach(({ circle }) => {
			circle.x = Math.random() * width
			circle.y = Math.random() * height
			const [r, g, b] = [randomBetween(config.minR,config.maxR), randomBetween(config.minG,config.maxG), randomBetween(config.minB,config.maxB)]
			circle.tint = `rgb(${r},${g},${b})`
		})

		let audio = new Array(audioChannels).fill(0)

		app.ticker.add((delta) => {
			circles.forEach(({ circle, velocity }, index) => {

				const audioBoost = 1 + audio[index%audioChannels]

				let [dx, dy] = velocity
				if (circle.x > width || circle.x < 0) {
					dx = dx * -1
					circles[index].velocity[0] = dx
				}
				if (circle.y > height || circle.y < 0) {
					dy = dy * -1
					circles[index].velocity[1] = dy
				}
				circle.x = circle.x + dx * delta * audioBoost
				circle.y = circle.y + dy * delta * audioBoost
			})
		})
		const wallpaperAudioListener = a => {audio = a.map(v=>Math.max(v,1))}
		window.wallpaperRegisterAudioListener && window.wallpaperRegisterAudioListener(wallpaperAudioListener)
	</script>
</body>

</html>